---
version: '3'

volumes:
  data-postgres: {}
  data-opennms: {}
  data-opennms-cfg: {}

services:
  database:
    image: ${DOCKER_REGISTRY:-docker.io}/postgres:${POSTGRES_VERSION:-14.5}
    hostname: database
    environment:
      TZ: ${TIMEZONE:-America/New_York}
      POSTGRES_HOST: database
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - data-postgres:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 30s
      retries: 3

  horizon:
    image: ${DOCKER_REGISTRY:-docker.io}/${DOCKER_ORG:-opennms}/${HORIZON_OCI:-horizon}:${ONMS_VERSION:-release-30.x}
    hostname: horizon
    sysctls:
      net.ipv4.ping_group_range: "0 429496729"
    depends_on:
      - database
    environment:
      TZ: ${TIMEZONE:-America/New_York}
    volumes:
      # we overlay folder with kar into maven repo. It contains the plugin jars and dependencies:
      - ${USER_HOME}/.m2/repository/org/opennms/plugins/cloud/assembly/org.opennms.plugins.cloud.assembly.kar/1.0.0-SNAPSHOT/org.opennms.plugins.cloud.assembly.kar-1.0.0-SNAPSHOT.kar:/usr/share/opennms/.m2/repository/org/opennms/plugins/cloud/assembly/org.opennms.plugins.cloud.assembly.kar/1.0.0-SNAPSHOT/org.opennms.plugins.cloud.assembly.kar-1.0.0-SNAPSHOT.kar:ro
      # add CloudMock server into horizon container: We will run our tests against it.
      # the path is a bit ugly but the jar is not yet in the local mvn repo.
      - ../../../target:/usr/share/opennms/.m2/repository/org/opennms/plugins/cloud/it-test/1.0.0-SNAPSHOT:ro

    command: ["-s"]
    ports:
      - "8101:8101/tcp" # ssh port for karaf console
    healthcheck:
      test: [ "CMD", "curl", "-f", "-I", "http://localhost:8980/opennms/login.jsp" ]
      interval: 1m
      timeout: 5s
      retries: 3

  sentinel:
    image: ${DOCKER_REGISTRY:-docker.io}/${DOCKER_ORG:-opennms}/${MINION_OCI:-sentinel}:${ONMS_VERSION:-release-30.x}
    hostname: sentinel
    sysctls:
      net.ipv4.ping_group_range: "0 429496729"
    depends_on:
      - database
    environment:
      TZ: ${TIMEZONE:-America/New_York}
      JAVA_MIN_MEM: 512M
      JAVA_MAX_MEM: 2048M
    volumes:
      # we overlay folder with kar into system repo. It contains the plugin jars and dependencies:
      - ${USER_HOME}/.m2/repository/org/opennms/plugins/cloud/assembly/org.opennms.plugins.cloud.assembly.kar/1.0.0-SNAPSHOT/org.opennms.plugins.cloud.assembly.kar-1.0.0-SNAPSHOT.kar:/usr/share/opennms/.m2/repository/org/opennms/plugins/cloud/assembly/org.opennms.plugins.cloud.assembly.kar/1.0.0-SNAPSHOT/org.opennms.plugins.cloud.assembly.kar-1.0.0-SNAPSHOT.kar:ro
    command: ["-f"]
    ports:
      - "8301:8301/tcp" # ssh port for karaf console
    healthcheck:
      test: "/health.sh"
      interval: 30s
      timeout: 20s
      retries: 3
